name: üé≤ 539 Lottery Automation

on:
  schedule:
    # ‰∏äÂçà 9:00 (Âè∞ÁÅ£ÊôÇÈñì) - È†êÊ∏¨ÈöéÊÆµ
    - cron: '0 1 * * *'   # UTC 01:00 = Âè∞ÁÅ£ÊôÇÈñì 09:00
    # Êôö‰∏ä 10:00 (Âè∞ÁÅ£ÊôÇÈñì) - Ë®òÈåÑÈ©óË≠âÈöéÊÆµ  
    - cron: '0 14 * * *'  # UTC 14:00 = Âè∞ÁÅ£ÊôÇÈñì 22:00
  workflow_dispatch: # ÂÖÅË®±ÊâãÂãïËß∏Áôº

jobs:
  # ‰∏äÂçàÂü∑Ë°åÔºöÁîüÊàêÈ†êÊ∏¨ÔºàÈÄ±‰∏ÄÂà∞ÈÄ±ÂÖ≠Ôºâ
  morning-prediction:
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 1 * * *' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: üîÑ Checkout repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-api-python-client google-auth-httplib2 google-auth-oauthlib taiwanlottery>=1.5.1

    - name: üîê Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    - name: ‚¨áÔ∏è Download historical lottery data
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
      
    - name: üìä Generate daily predictions
      run: python lottery_prediction_only.py
      
    - name: ‚¨ÜÔ∏è Upload predictions to Google Drive
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: python scripts/upload_to_drive.py
      
    - name: üìã Archive predictions
      uses: actions/upload-artifact@v4
      with:
        name: morning-predictions-${{ github.run_number }}
        path: |
          prediction_log.xlsx
          *.log
        retention-days: 30

  # Êôö‰∏äÂü∑Ë°åÔºöË®òÈåÑÈñãÁçéÁµêÊûú‰∏¶È©óË≠âÔºàÈÄ±‰∏ÄÂà∞ÈÄ±ÂÖ≠Ôºâ
  evening-verification:
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 14 * * *' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: üîÑ Checkout repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-api-python-client google-auth-httplib2 google-auth-oauthlib requests beautifulsoup4 taiwanlottery>=1.5.1

    - name: üîê Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    - name: ‚¨áÔ∏è Download existing lottery history
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
        
    - name: üéØ Crawl latest lottery results
      run: python lottery_crawler.py
      
    - name: ‚¨ÜÔ∏è Update lottery history to Google Drive
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/upload_lottery_hist.py
      
    - name: ‚¨áÔ∏è Download prediction log
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_prediction_log.py
      
    - name: üîç Verify predictions
      run: python verify_predictions.py
      
    - name: ‚¨ÜÔ∏è Update verification results
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
      run: python scripts/upload_to_drive.py
      
    - name: üìã Archive verification results
      uses: actions/upload-artifact@v4
      with:
        name: evening-verification-${{ github.run_number }}
        path: |
          lottery_hist.xlsx
          prediction_log.xlsx
          *.log
        retention-days: 30
