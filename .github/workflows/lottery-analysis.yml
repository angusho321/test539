name: 🎲 539 Lottery Automation

on:
  schedule:
    # 上午 9:00 (台灣時間) - 完整流程：記錄開獎+驗證昨日+預測今日
    - cron: '0 1 * * *'   # UTC 01:00 = 台灣時間 09:00
  workflow_dispatch: # 允許手動觸發

jobs:
  # 早上執行：記錄開獎+驗證昨日+預測今日（週一到週六）
  daily-lottery-process:
    runs-on: ubuntu-latest
    # 移除過於嚴格的條件判斷，讓 workflow 正常執行
    
    steps:
    - name: 🔄 Checkout repository
      uses: actions/checkout@v4
      
    - name: 📅 Debug workflow trigger
      run: |
        echo "Workflow triggered by: ${{ github.event_name }}"
        echo "Schedule: ${{ github.event.schedule }}"
        echo "Current time: $(date)"
        echo "UTC time: $(date -u)"
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-api-python-client google-auth-httplib2 google-auth-oauthlib requests beautifulsoup4 taiwanlottery>=1.5.1

    - name: 🔐 Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    # 步驟 1: 記錄昨天的開獎號碼
    - name: ⬇️ Download existing lottery history
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
        
    - name: 🔄 Ensure complete lottery history (one-time setup)
      run: |
        echo "📊 檢查歷史記錄完整性..."
        python -c "
        import pandas as pd
        from pathlib import Path
        if Path('lottery_hist.xlsx').exists():
            df = pd.read_excel('lottery_hist.xlsx')
            print(f'目前記錄筆數: {len(df)}')
            if len(df) < 1500:
                print('⚠️ 記錄不完整，執行完整更新...')
                exit(1)
            else:
                print('✅ 歷史記錄完整')
        else:
            print('❌ 沒有歷史檔案')
            exit(1)
        " || (echo "執行完整更新..." && python scripts/update_lottery_history_with_taiwanlottery.py)
        
    - name: 🎯 Crawl latest lottery results (記錄昨天開獎)
      run: python lottery_crawler.py
      
    - name: ⬆️ Update lottery history to Google Drive
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/upload_lottery_hist.py
      
    # 步驟 2: 驗證昨日的預測
    - name: ⬇️ Download prediction log
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_prediction_log.py
      
    - name: 🔍 Verify yesterday's predictions
      run: python verify_predictions.py
      
    # 步驟 3: 預測今日的號碼
    - name: 📊 Generate today's predictions
      run: python lottery_prediction_only.py
      
    - name: ⬆️ Upload all results to Google Drive
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: python scripts/upload_to_drive.py
      
    - name: 📋 Archive daily results
      uses: actions/upload-artifact@v4
      with:
        name: daily-lottery-process-${{ github.run_number }}
        path: |
          lottery_hist.xlsx
          prediction_log.xlsx
          *.log
        retention-days: 30
