name: ğŸ² 539 Lottery Automation

on:
  schedule:
    # ä¸Šåˆ 9:00 (å°ç£æ™‚é–“) - å®Œæ•´æµç¨‹ï¼šè¨˜éŒ„é–‹ç+é©—è­‰æ˜¨æ—¥+é æ¸¬ä»Šæ—¥
    - cron: '0 1 * * *'   # UTC 01:00 = å°ç£æ™‚é–“ 09:00
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  # æ—©ä¸ŠåŸ·è¡Œï¼šè¨˜éŒ„é–‹ç+é©—è­‰æ˜¨æ—¥+é æ¸¬ä»Šæ—¥ï¼ˆé€±ä¸€åˆ°é€±å…­ï¼‰
  daily-lottery-process:
    runs-on: ubuntu-latest
    # ç§»é™¤éæ–¼åš´æ ¼çš„æ¢ä»¶åˆ¤æ–·ï¼Œè®“ workflow æ­£å¸¸åŸ·è¡Œ
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“… Debug workflow trigger
      run: |
        echo "Workflow triggered by: ${{ github.event_name }}"
        echo "Schedule: ${{ github.event.schedule }}"
        echo "Current time: $(date)"
        echo "UTC time: $(date -u)"
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-api-python-client google-auth-httplib2 google-auth-oauthlib requests beautifulsoup4 taiwanlottery>=1.5.1

    - name: ğŸ” Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    # æ­¥é©Ÿ 1: è¨˜éŒ„æ˜¨å¤©çš„é–‹çè™Ÿç¢¼
    - name: â¬‡ï¸ Download existing lottery history
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
        
    - name: ğŸ”„ Ensure complete lottery history (one-time setup)
      run: |
        echo "ğŸ“Š æª¢æŸ¥æ­·å²è¨˜éŒ„å®Œæ•´æ€§..."
        python -c "
        import pandas as pd
        from pathlib import Path
        if Path('lottery_hist.xlsx').exists():
            df = pd.read_excel('lottery_hist.xlsx')
            print(f'ç›®å‰è¨˜éŒ„ç­†æ•¸: {len(df)}')
            if len(df) < 1500:
                print('âš ï¸ è¨˜éŒ„ä¸å®Œæ•´ï¼ŒåŸ·è¡Œå®Œæ•´æ›´æ–°...')
                exit(1)
            else:
                print('âœ… æ­·å²è¨˜éŒ„å®Œæ•´')
        else:
            print('âŒ æ²’æœ‰æ­·å²æª”æ¡ˆ')
            exit(1)
        " || (echo "åŸ·è¡Œå®Œæ•´æ›´æ–°..." && python scripts/update_lottery_history_with_taiwanlottery.py)
        
    - name: ğŸ¯ Crawl latest lottery results (è¨˜éŒ„æ˜¨å¤©é–‹ç)
      run: python lottery_crawler.py
      
    - name: â¬†ï¸ Update lottery history to Google Drive
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/upload_lottery_hist.py
      
    # æ­¥é©Ÿ 2: é©—è­‰æ˜¨æ—¥çš„é æ¸¬
    - name: â¬‡ï¸ Download prediction log
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_prediction_log.py
      
    - name: ğŸ” Verify yesterday's predictions
      run: python verify_predictions.py
      
    # æ­¥é©Ÿ 3: é æ¸¬ä»Šæ—¥çš„è™Ÿç¢¼
    - name: ğŸ“Š Generate today's predictions
      run: python lottery_prediction_only.py
      
    - name: â¬†ï¸ Upload all results to Google Drive
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: python scripts/upload_to_drive.py
      
    - name: ğŸ“‹ Archive daily results
      uses: actions/upload-artifact@v4
      with:
        name: daily-lottery-process-${{ github.run_number }}
        path: |
          lottery_hist.xlsx
          prediction_log.xlsx
          *.log
        retention-days: 30
