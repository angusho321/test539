name: ğŸ² 539 Lottery Automation

on:
  schedule:
    # ä¸Šåˆ 9:00 (å°ç£æ™‚é–“) - é æ¸¬éšæ®µ
    - cron: '0 1 * * *'   # UTC 01:00 = å°ç£æ™‚é–“ 09:00
    # æ™šä¸Š 10:00 (å°ç£æ™‚é–“) - è¨˜éŒ„é©—è­‰éšæ®µ  
    - cron: '0 14 * * *'  # UTC 14:00 = å°ç£æ™‚é–“ 22:00
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  # ä¸ŠåˆåŸ·è¡Œï¼šç”Ÿæˆé æ¸¬ï¼ˆé€±ä¸€åˆ°é€±å…­ï¼‰
  morning-prediction:
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 1 * * *' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-api-python-client google-auth-httplib2 google-auth-oauthlib taiwanlottery>=1.5.1

    - name: ğŸ” Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    - name: â¬‡ï¸ Download historical lottery data
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
      
    - name: ğŸ“Š Generate daily predictions
      run: python lottery_prediction_only.py
      
    - name: â¬†ï¸ Upload predictions to Google Drive
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: python scripts/upload_to_drive.py
      
    - name: ğŸ“‹ Archive predictions
      uses: actions/upload-artifact@v4
      with:
        name: morning-predictions-${{ github.run_number }}
        path: |
          prediction_log.xlsx
          *.log
        retention-days: 30

  # æ™šä¸ŠåŸ·è¡Œï¼šè¨˜éŒ„é–‹ççµæœä¸¦é©—è­‰ï¼ˆé€±ä¸€åˆ°é€±å…­ï¼‰
  evening-verification:
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 14 * * *' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-api-python-client google-auth-httplib2 google-auth-oauthlib requests beautifulsoup4 taiwanlottery>=1.5.1

    - name: ğŸ” Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    - name: â¬‡ï¸ Download existing lottery history
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
        
    - name: ğŸ”„ Ensure complete lottery history (one-time setup)
      run: |
        echo "ğŸ“Š æª¢æŸ¥æ­·å²è¨˜éŒ„å®Œæ•´æ€§..."
        python -c "
        import pandas as pd
        from pathlib import Path
        if Path('lottery_hist.xlsx').exists():
            df = pd.read_excel('lottery_hist.xlsx')
            print(f'ç›®å‰è¨˜éŒ„ç­†æ•¸: {len(df)}')
            if len(df) < 1500:
                print('âš ï¸ è¨˜éŒ„ä¸å®Œæ•´ï¼ŒåŸ·è¡Œå®Œæ•´æ›´æ–°...')
                exit(1)
            else:
                print('âœ… æ­·å²è¨˜éŒ„å®Œæ•´')
        else:
            print('âŒ æ²’æœ‰æ­·å²æª”æ¡ˆ')
            exit(1)
        " || python scripts/update_lottery_history_with_taiwanlottery.py
        
    - name: ğŸ¯ Crawl latest lottery results
      run: python lottery_crawler.py
      
    - name: â¬†ï¸ Update lottery history to Google Drive
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/upload_lottery_hist.py
      
    - name: â¬‡ï¸ Download prediction log
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_prediction_log.py
      
    - name: ğŸ” Verify predictions
      run: python verify_predictions.py
      
    - name: â¬†ï¸ Update verification results
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
      run: python scripts/upload_to_drive.py
      
    - name: ğŸ“‹ Archive verification results
      uses: actions/upload-artifact@v4
      with:
        name: evening-verification-${{ github.run_number }}
        path: |
          lottery_hist.xlsx
          prediction_log.xlsx
          *.log
        retention-days: 30
