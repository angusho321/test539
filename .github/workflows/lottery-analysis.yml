name: ğŸ² 539 Lottery Automation

on:
  schedule:
    # æ¯å¤©ä¸Šåˆ 9:00 (å°ç£æ™‚é–“) - å®Œæ•´æµç¨‹ï¼šè¨˜éŒ„é–‹ç+é©—è­‰æ˜¨æ—¥+é æ¸¬ä»Šæ—¥
    - cron: '0 1 * * *'   # UTC 01:00 = å°ç£æ™‚é–“ 09:00
  workflow_dispatch: {} # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  # æ—©ä¸ŠåŸ·è¡Œï¼šè¨˜éŒ„é–‹ç+é©—è­‰æ˜¨æ—¥+é æ¸¬ä»Šæ—¥ï¼ˆé€±ä¸€åˆ°é€±å…­ï¼‰
  daily-lottery-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ” Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    # æª¢æŸ¥æ˜¯å¦ç‚ºé€±æ—¥ï¼ˆ539 é€±æ—¥ä¸é–‹çï¼‰
    - name: ğŸ“… Check if Sunday (skip lottery on Sunday)
      id: check_sunday
      run: |
        DAY_OF_WEEK=$(date -u +%u)
        if [ "$DAY_OF_WEEK" = "7" ]; then
          echo "is_sunday=true" >> $GITHUB_OUTPUT
          echo "ğŸ“… ä»Šå¤©æ˜¯é€±æ—¥ï¼Œ539 ä¸é–‹çï¼Œè·³éé æ¸¬æµç¨‹"
        else
          echo "is_sunday=false" >> $GITHUB_OUTPUT
          echo "ğŸ“… ä»Šå¤©ä¸æ˜¯é€±æ—¥ï¼ŒåŸ·è¡Œæ­£å¸¸æµç¨‹"
        fi
    
    # æª¢æŸ¥æ˜¯å¦ç‚ºé€±äºŒï¼ˆ539 é€±ä¸€ç­–ç•¥åŸ·è¡Œæ—¥ï¼‰
    - name: ğŸ“… Check if Tuesday (Monday Strategy execution day)
      id: check_tuesday
      run: |
        DAY_OF_WEEK=$(date -u +%u)
        if [ "$DAY_OF_WEEK" = "2" ]; then
          echo "is_tuesday=true" >> $GITHUB_OUTPUT
          echo "ğŸ“… ä»Šå¤©æ˜¯é€±äºŒï¼ŒåŸ·è¡Œé€±ä¸€ç­–ç•¥åˆ†æ"
        else
          echo "is_tuesday=false" >> $GITHUB_OUTPUT
          echo "ğŸ“… ä»Šå¤©ä¸æ˜¯é€±äºŒï¼Œè·³éé€±ä¸€ç­–ç•¥åˆ†æ"
        fi
    
    # æ­¥é©Ÿ 1: è¨˜éŒ„æ˜¨å¤©çš„é–‹çè™Ÿç¢¼ï¼ˆæ¯å¤©åŸ·è¡Œï¼ŒåŒ…æ‹¬é€±æ—¥ï¼‰
    - name: â¬‡ï¸ Download existing lottery history
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
        
    - name: ğŸ”„ Ensure complete lottery history (one-time setup)
      run: |
        echo "ğŸ“Š æª¢æŸ¥æ­·å²è¨˜éŒ„å®Œæ•´æ€§..."
        python -c "
        import pandas as pd
        from pathlib import Path
        if Path('lottery_hist.xlsx').exists():
            df = pd.read_excel('lottery_hist.xlsx')
            print(f'ç›®å‰è¨˜éŒ„ç­†æ•¸: {len(df)}')
            if len(df) < 1500:
                print('âš ï¸ è¨˜éŒ„ä¸å®Œæ•´ï¼ŒåŸ·è¡Œå®Œæ•´æ›´æ–°...')
                exit(1)
            else:
                print('âœ… æ­·å²è¨˜éŒ„å®Œæ•´')
        else:
            print('âŒ æ²’æœ‰æ­·å²æª”æ¡ˆ')
            exit(1)
        " || python scripts/update_lottery_history_with_taiwanlottery.py
        
    - name: ğŸ¯ Crawl latest lottery results (è¨˜éŒ„æ˜¨å¤©é–‹ç)
      run: python lottery_crawler.py
      
    - name: â¬†ï¸ Update lottery history to Google Drive
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/upload_lottery_hist.py
      
    # æ­¥é©Ÿ 1.5: ä¸‹è¼‰ç¾æœ‰çš„é€±ä¸€ç­–ç•¥æª”æ¡ˆï¼ˆåƒ…é€±äºŒåŸ·è¡Œï¼‰
    - name: â¬‡ï¸ Download existing 539 Monday Strategy (Tuesday only)
      if: steps.check_tuesday.outputs.is_tuesday == 'true'
      env:
        MONDAY_STRATEGY_539_FILE_ID: ${{ secrets.MONDAY_STRATEGY_539_FILE_ID }}
      run: python scripts/download_539_monday_strategy.py
      
    # æ­¥é©Ÿ 1.6: åŸ·è¡Œé€±ä¸€å† è»ç­–ç•¥åˆ†æï¼ˆåƒ…é€±äºŒåŸ·è¡Œï¼‰
    - name: ğŸ¯ Add Monday Strategy Analysis Sheet (Tuesday only)
      if: steps.check_tuesday.outputs.is_tuesday == 'true'
      run: |
        echo "ğŸ“… ä»Šå¤©æ˜¯é€±äºŒï¼ŒåŸ·è¡Œé€±ä¸€å† è»ç­–ç•¥åˆ†æ..."
        python scripts/add_strategy_sheet.py --type 539 --file lottery_hist.xlsx
      
    # æ­¥é©Ÿ 1.7: ä¸Šå‚³é€±ä¸€ç­–ç•¥æª”æ¡ˆï¼ˆåƒ…é€±äºŒåŸ·è¡Œï¼‰
    - name: â¬†ï¸ Upload 539 Monday Strategy (Tuesday only)
      if: steps.check_tuesday.outputs.is_tuesday == 'true'
      env:
        MONDAY_STRATEGY_539_FILE_ID: ${{ secrets.MONDAY_STRATEGY_539_FILE_ID }}
      run: python scripts/upload_539_monday_strategy.py
      
    # æ­¥é©Ÿ 2: é©—è­‰æ˜¨æ—¥çš„é æ¸¬ï¼ˆé€±æ—¥è·³éï¼‰
    - name: â¬‡ï¸ Download prediction log
      if: steps.check_sunday.outputs.is_sunday != 'true'
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_prediction_log.py
      
    - name: ğŸ” Verify yesterday's predictions
      if: steps.check_sunday.outputs.is_sunday != 'true'
      run: python verify_predictions.py
      
    # æ­¥é©Ÿ 3: é æ¸¬ä»Šæ—¥çš„è™Ÿç¢¼ï¼ˆé€±æ—¥è·³éï¼‰
    - name: ğŸ“Š Generate today's predictions
      if: steps.check_sunday.outputs.is_sunday != 'true'
      run: python lottery_prediction_only.py
    
    # æ­¥é©Ÿ 4: æ¯é€±æ—¥åŸ·è¡Œé€²éšç­–ç•¥åˆ†æ (539ï¼šä¸€å¹´+è¿‘ä¸‰å€‹æœˆé›™æ¬„ï¼Œç”¢å‡º best_strategies_539.xlsx)
    - name: ğŸ§  Run Advanced Strategy Analysis (539, weekly Sunday)
      env:
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        BEST_STRATEGIES_539_FILE_ID: ${{ secrets.BEST_STRATEGIES_539_FILE_ID }}
      run: |
        DAY_OF_WEEK=$(date -u +%u)
        if [ "$DAY_OF_WEEK" = "7" ]; then
          echo "ğŸ“… é€±æ—¥ï¼šåŸ·è¡Œ 539 é€²éšç­–ç•¥åˆ†æï¼ˆä¸€å¹´+ä¸‰å€‹æœˆï¼‰..."
          python auto_analyze_strategies.py --type 539
        else
          echo "â­ï¸ éé€±æ—¥ï¼Œè·³éé€²éšç­–ç•¥åˆ†æ"
        fi
      
    - name: â¬†ï¸ Upload all results to Google Drive
      env:
        PREDICTION_LOG_FILE_ID: ${{ secrets.PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: |
        # é€±æ—¥å¯èƒ½æ²’æœ‰é æ¸¬è¨˜éŒ„ï¼Œä½†é‚„æ˜¯å˜—è©¦ä¸Šå‚³ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
        if [ -f "prediction_log.xlsx" ]; then
          python scripts/upload_to_drive.py
        else
          echo "ğŸ“… é€±æ—¥ç„¡é æ¸¬è¨˜éŒ„ï¼Œè·³éä¸Šå‚³é æ¸¬è¨˜éŒ„"
        fi
      
    - name: ğŸ“‹ Archive daily results
      uses: actions/upload-artifact@v4
      with:
        name: daily-lottery-process-${{ github.run_number }}
        path: |
          lottery_hist.xlsx
          prediction_log.xlsx
          best_strategies_539.xlsx
          539_monday_strategy.xlsx
          *.log
        retention-days: 30
