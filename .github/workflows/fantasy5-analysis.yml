name: ğŸ² California Fantasy 5 Lottery Automation

on:
  schedule:
    # æ™šä¸Š 22:00 (å°ç£æ™‚é–“) - åŠ å·Fantasy 5å®Œæ•´æµç¨‹
    - cron: '0 14 * * *'   # UTC 14:00 = å°ç£ 22:00
  workflow_dispatch: {} # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  daily-fantasy5-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸŒ Setup Chrome for Selenium
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: ğŸ” Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    # --- ä¸‹è¼‰å€ï¼šåŒæ™‚ä¸‹è¼‰å¤©å¤©æ¨‚å’Œ 539 çš„æ­·å²ç´€éŒ„ ---
    - name: â¬‡ï¸ Download existing Fantasy 5 history
      env:
        FANTASY5_HIST_FILE_ID: ${{ secrets.FANTASY5_HIST_FILE_ID }}
      run: python scripts/download_fantasy5_from_drive.py

    - name: â¬‡ï¸ Download 539 history (For Combined Analysis)
      env:
        LOTTERY_HIST_FILE_ID: ${{ secrets.LOTTERY_HIST_FILE_ID }}
      run: python scripts/download_from_drive.py
        
    # --- çˆ¬èŸ²å€ï¼šæ›´æ–°å¤©å¤©æ¨‚è³‡æ–™ ---
    - name: ğŸ¯ Crawl latest Fantasy 5 results
      run: python fantasy5_crawler.py
      
    - name: â¬†ï¸ Update Fantasy 5 history to Google Drive
      env:
        FANTASY5_HIST_FILE_ID: ${{ secrets.FANTASY5_HIST_FILE_ID }}
      run: python scripts/upload_fantasy5_hist.py
      
    # --- é æ¸¬å€ï¼šåŸ·è¡Œæ—¢æœ‰çš„ 7/9 ç¢¼é æ¸¬ ---
    - name: â¬‡ï¸ Download Fantasy 5 prediction log
      env:
        FANTASY5_PREDICTION_LOG_FILE_ID: ${{ secrets.FANTASY5_PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_fantasy5_prediction_log.py
      
    - name: ğŸ” Verify yesterday's Fantasy 5 predictions
      run: python verify_fantasy5_predictions.py
      
    - name: ğŸ“Š Generate today's Fantasy 5 predictions
      run: python fantasy5_prediction_only.py

    # ========================================================
    # â˜… æ–°å¢æ­¥é©Ÿï¼šåŸ·è¡Œã€Œé€£èŠ/çŸ­æœŸ/é•·æœŸã€ç¸½åˆ†æ (539 + å¤©å¤©æ¨‚)
    # ========================================================
    - name: ğŸ§  Run Auto Strategy Analysis (Combined)
      env:
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: python auto_analyze_strategies.py
      
    # --- ä¸Šå‚³èˆ‡æ­¸æª” ---
    - name: â¬†ï¸ Upload all Fantasy 5 results to Google Drive
      env:
        FANTASY5_PREDICTION_LOG_FILE_ID: ${{ secrets.FANTASY5_PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: python scripts/upload_fantasy5_to_drive.py
      
    - name: ğŸ“‹ Archive daily results
      uses: actions/upload-artifact@v4
      with:
        name: daily-fantasy5-process-${{ github.run_number }}
        path: |
          fantasy5_hist.xlsx
          lottery_hist.xlsx
          fantasy5_prediction_log.xlsx
          best_strategies_539.csv
          best_strategies_fantasy5.csv
          *.log
        retention-days: 30