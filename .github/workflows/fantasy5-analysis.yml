name: ğŸ² California Fantasy 5 Lottery Automation

on:
  schedule:
    # æ¯å¤©æ™šä¸Š 22:00 (å°ç£æ™‚é–“) - åŠ å·Fantasy 5å®Œæ•´æµç¨‹
    - cron: '0 14 * * *'   # UTC 14:00 = å°ç£ 22:00
  workflow_dispatch: {} # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  daily-fantasy5-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸŒ Setup Chrome for Selenium
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: ğŸ” Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    # ========================================================
    # ä¸‹è¼‰æ­·å²è³‡æ–™å€
    # ========================================================
    - name: â¬‡ï¸ Download existing Fantasy 5 history
      env:
        FANTASY5_HIST_FILE_ID: ${{ secrets.FANTASY5_HIST_FILE_ID }}
      run: python scripts/download_fantasy5_from_drive.py
        
    # ========================================================
    
    # --- å¤©å¤©æ¨‚çˆ¬èŸ²æ›´æ–° ---
    - name: ğŸ¯ Crawl latest Fantasy 5 results (è¨˜éŒ„æ˜¨å¤©é–‹ç)
      run: python fantasy5_crawler.py
      
    - name: â¬†ï¸ Update Fantasy 5 history to Google Drive
      env:
        FANTASY5_HIST_FILE_ID: ${{ secrets.FANTASY5_HIST_FILE_ID }}
      run: python scripts/upload_fantasy5_hist.py
      
    # --- é æ¸¬èˆ‡é©—è­‰å€ ---
    - name: â¬‡ï¸ Download Fantasy 5 prediction log
      env:
        FANTASY5_PREDICTION_LOG_FILE_ID: ${{ secrets.FANTASY5_PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_fantasy5_prediction_log.py
      
    - name: ğŸ” Verify yesterday's Fantasy 5 predictions
      run: python verify_fantasy5_predictions.py
      
    - name: ğŸ“Š Generate today's Fantasy 5 predictions
      run: python fantasy5_prediction_only.py

    # ========================================================
    # â˜… åŸ·è¡Œé€²éšç­–ç•¥åˆ†æ (åƒ…åˆ†æå¤©å¤©æ¨‚ï¼Œåƒ…é€±ä¸€åŸ·è¡Œ)
    # ========================================================
    - name: ğŸ§  Run Advanced Strategy Analysis (Fantasy5 only, Monday only)
      env:
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        BEST_STRATEGIES_FANTASY5_FILE_ID: ${{ secrets.BEST_STRATEGIES_FANTASY5_FILE_ID }}
      run: |
        DAY_OF_WEEK=$(date -u +%u)
        if [ "$DAY_OF_WEEK" = "1" ]; then
          echo "ğŸ“… ä»Šå¤©æ˜¯é€±ä¸€ï¼ŒåŸ·è¡Œé€²éšç­–ç•¥åˆ†æ..."
          python auto_analyze_strategies.py --type fantasy5
        else
          echo "â­ï¸ ä»Šå¤©ä¸æ˜¯é€±ä¸€ï¼Œè·³éé€²éšç­–ç•¥åˆ†æ"
        fi
      
    # --- ä¸Šå‚³èˆ‡æ­¸æª” ---
    - name: â¬†ï¸ Upload Fantasy 5 Prediction Log
      env:
        FANTASY5_PREDICTION_LOG_FILE_ID: ${{ secrets.FANTASY5_PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: python scripts/upload_fantasy5_to_drive.py
      
    - name: ğŸ“‹ Archive daily results
      uses: actions/upload-artifact@v4
      with:
        name: daily-fantasy5-process-${{ github.run_number }}
        path: |
          fantasy5_hist.xlsx
          fantasy5_prediction_log.xlsx
          best_strategies_fantasy5.xlsx
          *.log
        retention-days: 30