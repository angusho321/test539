name: 🎲 California Fantasy 5 Lottery Automation

on:
  schedule:
    # 晚上 22:00 (台灣時間) - 加州Fantasy 5完整流程
    - cron: '0 14 * * *'   # UTC 14:00 = 台灣 22:00
  workflow_dispatch: # 允許手動觸發

jobs:
  # 晚上執行：記錄開獎+驗證昨日+預測今日（每日，包括週日）
  daily-fantasy5-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔄 Checkout repository
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 🌐 Setup Chrome for Selenium
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: 🔐 Setup Google Drive credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
        
    # 步驟 1: 記錄昨天的開獎號碼
    - name: ⬇️ Download existing Fantasy 5 history
      env:
        FANTASY5_HIST_FILE_ID: ${{ secrets.FANTASY5_HIST_FILE_ID }}
      run: python scripts/download_fantasy5_from_drive.py
        
    - name: 🔄 Ensure complete Fantasy 5 history (one-time setup)
      run: |
        echo "📊 檢查加州Fantasy 5歷史記錄完整性..."
        python -c "
        import pandas as pd
        from pathlib import Path
        if Path('fantasy5_hist.xlsx').exists():
            df = pd.read_excel('fantasy5_hist.xlsx')
            print(f'目前記錄筆數: {len(df)}')
            if len(df) < 100:
                print('⚠️ 記錄不完整，執行完整更新...')
                exit(1)
            else:
                print('✅ 歷史記錄完整')
        else:
            print('❌ 沒有歷史檔案')
            exit(1)
        " || python fantasy5_crawler.py
        
    - name: 🎯 Crawl latest Fantasy 5 results (記錄昨天開獎)
      run: python fantasy5_crawler.py
      
    - name: ⬆️ Update Fantasy 5 history to Google Drive
      env:
        FANTASY5_HIST_FILE_ID: ${{ secrets.FANTASY5_HIST_FILE_ID }}
      run: python scripts/upload_fantasy5_hist.py
      
    # 步驟 2: 驗證昨日的預測
    - name: ⬇️ Download Fantasy 5 prediction log
      env:
        FANTASY5_PREDICTION_LOG_FILE_ID: ${{ secrets.FANTASY5_PREDICTION_LOG_FILE_ID }}
      run: python scripts/download_fantasy5_prediction_log.py
      
    - name: 🔍 Verify yesterday's Fantasy 5 predictions
      run: python verify_fantasy5_predictions.py
      
    # 步驟 3: 預測今日的號碼
    - name: 📊 Generate today's Fantasy 5 predictions
      run: python fantasy5_prediction_only.py
      
    - name: ⬆️ Upload all Fantasy 5 results to Google Drive
      env:
        FANTASY5_PREDICTION_LOG_FILE_ID: ${{ secrets.FANTASY5_PREDICTION_LOG_FILE_ID }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: python scripts/upload_fantasy5_to_drive.py
      
    - name: 📋 Archive daily Fantasy 5 results
      uses: actions/upload-artifact@v4
      with:
        name: daily-fantasy5-process-${{ github.run_number }}
        path: |
          fantasy5_hist.xlsx
          fantasy5_prediction_log.xlsx
          *.log
        retention-days: 30
